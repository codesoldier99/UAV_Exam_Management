# 考试系统后端云服务器部署指南

## 🎯 部署目标
- **云服务器地址**: http://106.52.214.54/
- **当前状态**: 服务器在线，需要部署API服务
- **本地测试**: ✅ 通过 (API正常运行在localhost:8000)

## 📋 部署前检查清单

### 1. 本地环境状态 ✅
- [x] Git仓库已推送到GitHub
- [x] 本地API服务正常运行
- [x] Docker配置文件完整
- [x] 部署脚本准备就绪

### 2. 云服务器状态 ✅
- [x] 网络连通性正常 (ping 33ms平均延迟)
- [ ] HTTP服务未运行 (需要部署)
- [ ] Docker环境 (需要确认)

## 🚀 部署方案

### 方案A: Docker部署 (推荐)

#### 步骤1: 连接云服务器
```bash
# 使用SSH连接到云服务器
ssh root@106.52.214.54
# 或者使用您的用户名
ssh your_username@106.52.214.54
```

#### 步骤2: 安装必要软件
```bash
# 更新系统包
sudo apt update

# 安装Docker和Docker Compose
sudo apt install -y docker.io docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 安装Git
sudo apt install -y git
```

#### 步骤3: 克隆项目
```bash
# 克隆GitHub仓库
git clone https://github.com/codesoldier99/UAVexam_site_backend.git
cd UAVexam_site_backend
```

#### 步骤4: 配置环境变量
```bash
# 创建环境配置文件
cp env.example .env

# 编辑环境变量
nano .env
```

**环境变量配置**:
```bash
# 数据库配置
MYSQL_ROOT_PASSWORD=a_secret_password
MYSQL_DATABASE=exam_site_db_prod
SECRET_KEY=your-very-secure-secret-key-here

# API配置
DEBUG=False
HOST=0.0.0.0
PORT=80
```

#### 步骤5: 启动服务
```bash
# 使用生产环境配置启动
sudo chmod +x deploy.sh
sudo ./deploy.sh

# 或者直接使用Docker Compose
sudo docker-compose -f docker-compose.prod.yml up -d --build
```

#### 步骤6: 验证部署
```bash
# 检查容器状态
sudo docker-compose -f docker-compose.prod.yml ps

# 查看日志
sudo docker-compose -f docker-compose.prod.yml logs app

# 测试API
curl http://localhost/
curl http://localhost/health
```

### 方案B: 直接Python部署

#### 步骤1-3: 同方案A

#### 步骤4: 安装Python环境
```bash
# 安装Python和pip
sudo apt install -y python3 python3-pip python3-venv

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

#### 步骤5: 配置和启动
```bash
# 设置环境变量
export HOST=0.0.0.0
export PORT=80

# 启动服务 (需要sudo因为使用80端口)
sudo -E python start_server.py
```

## 🔧 快速部署脚本

创建自动化部署脚本：

```bash
#!/bin/bash
# 快速部署脚本 - 保存为 quick_deploy.sh

echo "🚀 开始部署考试系统后端..."

# 检查Docker
if ! command -v docker &> /dev/null; then
    echo "📦 安装Docker..."
    sudo apt update
    sudo apt install -y docker.io docker-compose
    sudo systemctl start docker
    sudo systemctl enable docker
fi

# 检查项目目录
if [ ! -d "UAVexam_site_backend" ]; then
    echo "📥 克隆项目..."
    git clone https://github.com/codesoldier99/UAVexam_site_backend.git
fi

cd UAVexam_site_backend

# 拉取最新代码
echo "🔄 更新代码..."
git pull origin main

# 设置环境变量
export MYSQL_ROOT_PASSWORD=a_secret_password
export MYSQL_DATABASE=exam_site_db_prod
export SECRET_KEY=exam-site-backend-secret-key-2025

# 构建和启动
echo "🔨 构建并启动服务..."
sudo docker-compose down
sudo docker-compose up -d --build

# 等待启动
echo "⏳ 等待服务启动..."
sleep 30

# 测试API
echo "🧪 测试API..."
curl -s http://localhost/ | grep -q "欢迎" && echo "✅ API启动成功!" || echo "❌ API启动失败"

echo "🎉 部署完成！"
echo "📊 访问地址:"
echo "   - API: http://106.52.214.54/"
echo "   - 文档: http://106.52.214.54/docs"
echo "   - 健康检查: http://106.52.214.54/health"
```

## 🔍 部署后验证

### API测试命令
```bash
# 基础测试
curl http://106.52.214.54/
curl http://106.52.214.54/health
curl http://106.52.214.54/test

# 功能测试
curl http://106.52.214.54/institutions
curl http://106.52.214.54/users
curl http://106.52.214.54/candidates
```

### 本地测试云服务器API
```python
import requests

# 测试根路径
response = requests.get('http://106.52.214.54/')
print(f"状态码: {response.status_code}")
print(f"响应: {response.json()}")

# 测试健康检查
health = requests.get('http://106.52.214.54/health')
print(f"健康状态: {health.json()}")

# 测试机构列表
institutions = requests.get('http://106.52.214.54/institutions')
print(f"机构数据: {institutions.json()}")
```

## 🛠️ 常见问题解决

### 1. 端口被占用
```bash
# 查看80端口占用
sudo lsof -i :80
sudo netstat -tulpn | grep :80

# 停止占用进程
sudo kill -9 <PID>
```

### 2. 权限问题
```bash
# 给用户添加docker权限
sudo usermod -aG docker $USER
# 重新登录后生效
```

### 3. 防火墙设置
```bash
# Ubuntu/Debian
sudo ufw allow 80
sudo ufw allow 443

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload
```

### 4. 查看日志
```bash
# Docker容器日志
sudo docker-compose logs app
sudo docker logs <container_name>

# 系统日志
sudo journalctl -u docker
```

## 📱 移动端测试

部署成功后，可以使用手机或平板测试API：

1. **浏览器测试**: 访问 `http://106.52.214.54/docs`
2. **Postman移动版**: 导入项目中的Postman集合
3. **小程序测试**: 配置微信小程序接口地址

## 🔐 安全加固建议

1. **HTTPS配置**: 配置SSL证书
2. **API认证**: 启用JWT认证
3. **防火墙**: 只开放必要端口
4. **备份策略**: 定期备份数据库
5. **监控**: 配置服务监控和日志

## 📞 技术支持

部署遇到问题时：
1. 检查部署日志
2. 确认网络配置
3. 验证环境变量
4. 查看错误信息
5. 联系技术支持

---

**下一步**: 选择部署方案并开始执行! 🚀